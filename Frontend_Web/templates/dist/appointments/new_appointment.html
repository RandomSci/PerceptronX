<!DOCTYPE html>
<html lang="en">

<head>
  <title>New Appointment | APR-CV</title>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="APR-CV Physical Therapy Management System">
  <meta name="keywords" content="PT, Physical Therapy, Rehab, Patient Management">
  <meta name="author" content="APR-CV Team">

  <link rel="icon" href="../static/assets/images/favicon.svg" type="image/x-icon"> 
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" id="main-font-link">
  <link rel="stylesheet" href="../static/assets/fonts/tabler-icons.min.css">
  <link rel="stylesheet" href="../static/assets/fonts/feather.css">
  <link rel="stylesheet" href="../static/assets/fonts/fontawesome.css">
  <link rel="stylesheet" href="../static/assets/fonts/material.css">
  <link rel="stylesheet" href="../static/assets/css/style.css" id="main-style-link">
  <link rel="stylesheet" href="../static/assets/css/style-preset.css">
  <!-- Select2 CSS -->
  <link rel="stylesheet" href="../static/assets/css/plugins/select2.min.css">
  <!-- DateTimePicker CSS -->
  <link rel="stylesheet" href="../static/assets/css/plugins/flatpickr.min.css">
</head>

<body data-pc-preset="preset-1" data-pc-direction="ltr" data-pc-theme="light">
  
  <div class="loader-bg">
    <div class="loader-track">
      <div class="loader-fill"></div>
    </div>
  </div>

  <!-- Sidebar -->
  <nav class="pc-sidebar">
    <div class="navbar-wrapper">
      <div class="m-header">
        <a href="/front-page" class="b-brand text-primary">
          <i class="ti ti-medical-cross fs-4"></i>
          <span class="ms-2 fw-bold">APR-CV</span>
        </a>
      </div>
      <div class="navbar-content">
        <ul class="pc-navbar">
          <li class="pc-item">
            <a href="/front-page" class="pc-link">
              <span class="pc-micon"><i class="ti ti-dashboard"></i></span>
              <span class="pc-mtext">Dashboard</span>
            </a>
          </li>
        
          <li class="pc-item pc-hasmenu">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-users"></i></span>
              <span class="pc-mtext">Patients</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/patients">Patient Directory</a></li>
              <li class="pc-item"><a class="pc-link" href="/patients/add">Add New Patient</a></li>
              <li class="pc-item"><a class="pc-link" href="/reports/patients">Patient Reports</a></li>
            </ul>
          </li>
        
          <li class="pc-item pc-hasmenu active pc-trigger">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-calendar"></i></span>
              <span class="pc-mtext">Appointments</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu" style="display: block;">
              <li class="pc-item"><a class="pc-link" href="/appointments">Schedule</a></li>
              <li class="pc-item active"><a class="pc-link" href="/appointments/new">New Appointment</a></li>
            </ul>
          </li>
        
          <li class="pc-item pc-hasmenu">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-activity"></i></span>
              <span class="pc-mtext">Exercise Library</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/exercises">Browse Exercises</a></li>
              <li class="pc-item"><a class="pc-link" href="/exercises/add">Upload New Exercise</a></li>
            </ul>
          </li>
        
          <li class="pc-item pc-hasmenu">
            <a href="#!" class="pc-link">
              <span class="pc-micon"><i class="ti ti-report"></i></span>
              <span class="pc-mtext">Treatment Plans</span>
              <span class="pc-arrow"><i data-feather="chevron-right"></i></span>
            </a>
            <ul class="pc-submenu">
              <li class="pc-item"><a class="pc-link" href="/treatment-plans/new">Create Plan</a></li>
              <li class="pc-item"><a class="pc-link" href="/treatment-plans">Manage Plans</a></li>
            </ul>
          </li>
        
          <li class="pc-item">
            <a href="/analytics" class="pc-link">
              <span class="pc-micon"><i class="ti ti-chart-bar"></i></span>
              <span class="pc-mtext">Analytics</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Header -->
  <header class="pc-header">
    <div class="header-wrapper"> 
      <div class="me-auto pc-mob-drp">
        <ul class="list-unstyled">
          <li class="pc-h-item pc-sidebar-collapse">
            <a href="#" class="pc-head-link ms-0" id="sidebar-hide">
              <i class="ti ti-menu-2"></i>
            </a>
          </li>
          <li class="pc-h-item pc-sidebar-popup">
            <a href="#" class="pc-head-link ms-0" id="mobile-collapse">
              <i class="ti ti-menu-2"></i>
            </a>
          </li>
          <li class="dropdown pc-h-item d-inline-flex d-md-none">
            <a class="pc-head-link dropdown-toggle arrow-none m-0"
              data-bs-toggle="dropdown"
              href="#"
              role="button"
              aria-haspopup="false"
              aria-expanded="false">
              <i class="ti ti-search"></i>
            </a>
            <div class="dropdown-menu pc-h-dropdown drp-search">
              <form class="px-3">
                <div class="form-group mb-0 d-flex align-items-center">
                  <i data-feather="search"></i>
                  <input type="search" class="form-control border-0 shadow-none" placeholder="Search here. . .">
                </div>
              </form>
            </div>
          </li>
          <li class="pc-h-item d-none d-md-inline-flex">
            <form class="header-search">
              <i data-feather="search" class="icon-search"></i>
              <input type="search" class="form-control" placeholder="Search here. . .">
            </form>
          </li>
        </ul>
      </div>

      <div class="ms-auto">
        <ul class="list-unstyled">
          <li class="dropdown pc-h-item">
            <a class="pc-head-link dropdown-toggle arrow-none me-0"
               data-bs-toggle="dropdown"
               href="#"
               role="button"
               aria-haspopup="false"
               aria-expanded="false">
              <i class="ti ti-mail"></i>
              {% if unread_messages_count > 0 %}
              <span class="badge bg-danger pc-h-badge dots"><span class="sr-only">{{ unread_messages_count }} unread messages</span></span>
              {% endif %}
            </a>
            <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown">
              <div class="dropdown-header d-flex align-items-center justify-content-between">
                <h5 class="m-0">Messages{% if unread_messages_count > 0 %} <span class="badge bg-light-danger text-danger">{{ unread_messages_count }} New</span>{% endif %}</h5>
                <a href="#!" class="pc-head-link bg-transparent"><i class="ti ti-x text-danger"></i></a>
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-header px-0 text-wrap header-notification-scroll position-relative" style="max-height: calc(100vh - 215px)">
                <div class="list-group list-group-flush w-100">
                  {% if recent_messages %}
                    {% for message in recent_messages %}
                    <a href="/messages/{{ message.message_id }}" class="list-group-item list-group-item-action">
                      <div class="d-flex">
                        <div class="flex-shrink-0">
                            <img src="/static/assets/images/user/therapist_11_1744631888.gif" alt="user-image" class="user-avtar">
                        </div>
                        <div class="flex-grow-1 ms-1">
                          <span class="float-end text-muted">{{ message.time_display }}</span>
                          <p class="text-body mb-1">{{ message.content|truncate(60) }}</p>
                          <span class="text-muted">{{ message.time_ago }}</span>
                        </div>
                      </div>
                    </a>
                    {% endfor %}
                  {% else %}
                    <div class="text-center p-3">
                      <p class="text-muted">No new messages</p>
                    </div>
                  {% endif %}
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="text-center py-2">
                <a href="/messages" class="link-primary">View all messages</a>
              </div>
            </div>
          </li>
          <li class="dropdown pc-h-item header-user-profile">
            <a class="pc-head-link dropdown-toggle arrow-none me-0"
              data-bs-toggle="dropdown"
              href="#"
              role="button"
              aria-haspopup="false"
              data-bs-auto-close="outside"
              aria-expanded="false">
              <img src="/static/assets/images/user/therapist_11_1744631888.gif" alt="user-image" class="user-avtar">
              <span>{{ first_name }} {{ last_name }}</span>
            </a>
            <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
              <div class="dropdown-header">
                <div class="d-flex mb-1">
                  <div class="flex-shrink-0">
                    <img src="/static/assets/images/user/therapist_11_1744631888.gif" alt="user-image" class="user-avtar">
                </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">{{ first_name }} {{ last_name }}</h6>
                    <span>Physical Therapist</span>
                  </div>
                  <a href="/logout" class="pc-head-link bg-transparent"><i class="ti ti-power text-danger"></i></a>
                </div>
              </div>
              <ul class="nav drp-tabs nav-fill nav-tabs" id="mydrpTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="drp-t1"
                    data-bs-toggle="tab"
                    data-bs-target="#drp-tab-1"
                    type="button"
                    role="tab"
                    aria-controls="drp-tab-1"
                    aria-selected="true"
                    ><i class="ti ti-user"></i> Profile</button
                  >
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="drp-t2"
                    data-bs-toggle="tab"
                    data-bs-target="#drp-tab-2"
                    type="button"
                    role="tab"
                    aria-controls="drp-tab-2"
                    aria-selected="false"
                    ><i class="ti ti-settings"></i> Setting</button
                  >
                </li>
              </ul>
              <div class="tab-content" id="mysrpTabContent">
                <div class="tab-pane fade show active" id="drp-tab-1" role="tabpanel" aria-labelledby="drp-t1" tabindex="0">
                  <a href="/profile/edit" class="dropdown-item">
                    <i class="ti ti-edit-circle"></i>
                    <span>Edit Profile</span>
                  </a>
                  <a href="/profile" class="dropdown-item">
                    <i class="ti ti-user"></i>
                    <span>View Profile</span>
                  </a>
                  <a href="/logout" class="dropdown-item">
                    <i class="ti ti-power"></i>
                    <span>Logout</span>
                  </a>
                </div>
                <div class="tab-pane fade" id="drp-tab-2" role="tabpanel" aria-labelledby="drp-t2" tabindex="0">
                  <a href="/support" class="dropdown-item">
                    <i class="ti ti-help"></i>
                    <span>Support</span>
                  </a>
                  <a href="/settings" class="dropdown-item">
                    <i class="ti ti-user"></i>
                    <span>Account Settings</span>
                  </a>
                  <a href="/privacy" class="dropdown-item">
                    <i class="ti ti-lock"></i>
                    <span>Privacy Center</span>
                  </a>
                  <a href="/feedback" class="dropdown-item">
                    <i class="ti ti-messages"></i>
                    <span>Feedback</span>
                  </a>
                  <a href="/activity" class="dropdown-item">
                    <i class="ti ti-list"></i>
                    <span>History</span>
                  </a>
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="pc-container">
    <div class="pc-content">
      
      <!-- Page Header -->
      <div class="page-header">
        <div class="page-block">
          <div class="row align-items-center">
            <div class="col-md-12">
              <div class="page-header-title">
                <h5 class="m-b-10">New Appointment</h5>
              </div>
              <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="/front-page">Home</a></li>
                <li class="breadcrumb-item"><a href="/appointments">Appointments</a></li>
                <li class="breadcrumb-item" aria-current="page">New Appointment</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- New Appointment Form -->
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <h5>Schedule New Appointment</h5>
            </div>
            <div class="card-body">
              {% if request.query_params.get('error') %}
                <div class="alert alert-danger" role="alert">
                  {% if request.query_params.get('error') == 'invalid_patient' %}
                    Invalid patient selected.
                  {% elif request.query_params.get('error') == 'invalid_time_format' %}
                    Invalid time format. Please use HH:MM format.
                  {% elif request.query_params.get('error') == 'db_error' %}
                    Database error. Please try again.
                  {% else %}
                    An error occurred. Please try again.
                  {% endif %}
                </div>
              {% endif %}
              
              <form id="appointmentForm" method="post" action="/appointments/new">
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label" for="patient_id">Patient <span class="text-danger">*</span></label>
                      <select class="form-select select2" id="patient_id" name="patient_id" required>
                        <option value="">Select Patient</option>
                        {% for patient in patients %}
                          <option value="{{ patient.patient_id }}">{{ patient.first_name }} {{ patient.last_name }}{% if patient.diagnosis %} - {{ patient.diagnosis }}{% endif %}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label" for="appointment_date">Date <span class="text-danger">*</span></label>
                          <input type="date" class="form-control" id="appointment_date" name="appointment_date" min="{{ today }}" value="{{ today }}" required>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="form-label" for="appointment_time">Time <span class="text-danger">*</span></label>
                          <input type="time" class="form-control" id="appointment_time" name="appointment_time" required>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label" for="duration">Duration</label>
                      <select class="form-select" id="duration" name="duration">
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60" selected>60 minutes</option>
                        <option value="90">90 minutes</option>
                        <option value="120">120 minutes</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label" for="appointment_type">Appointment Type</label>
                      <select class="form-select" id="appointment_type" name="appointment_type">
                        <option value="Initial Evaluation">Initial Evaluation</option>
                        <option value="Follow-up" selected>Follow-up</option>
                        <option value="Re-evaluation">Re-evaluation</option>
                        <option value="Discharge">Discharge</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-md-12">
                    <div class="form-group">
                      <label class="form-label" for="notes">Notes</label>
                      <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Enter any notes about this appointment"></textarea>
                    </div>
                  </div>
                  
                  <div class="col-md-12 d-flex align-items-center justify-content-end gap-2 mt-4">
                    <a href="/appointments" class="btn btn-light">Cancel</a>
                    <button type="submit" class="btn btn-primary">Schedule Appointment</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Scheduling Tips -->
        <div class="col-md-12 col-xl-6">
          <div class="card">
            <div class="card-header">
              <h5>Scheduling Tips</h5>
            </div>
            <div class="card-body">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex align-items-start">
                  <i class="ti ti-alarm me-3 text-primary fs-5 mt-1"></i>
                  <div>
                    <h6 class="mb-1">Optimal Scheduling</h6>
                    <p class="mb-0 text-muted">Schedule follow-up appointments during off-peak hours (10am-2pm) for better resource availability.</p>
                  </div>
                </li>
                <li class="list-group-item d-flex align-items-start">
                  <i class="ti ti-calendar-plus me-3 text-primary fs-5 mt-1"></i>
                  <div>
                    <h6 class="mb-1">Recurring Appointments</h6>
                    <p class="mb-0 text-muted">For patients needing regular therapy, consider scheduling multiple appointments at once.</p>
                  </div>
                </li>
                <li class="list-group-item d-flex align-items-start">
                  <i class="ti ti-notes me-3 text-primary fs-5 mt-1"></i>
                  <div>
                    <h6 class="mb-1">Detailed Notes</h6>
                    <p class="mb-0 text-muted">Include specific preparation instructions or requirements in the notes section.</p>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Availability At-a-Glance -->
        <div class="col-md-12 col-xl-6">
          <div class="card">
            <div class="card-header">
              <h5>Today's Availability</h5>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Morning (8:00 AM - 12:00 PM)</span>
                    <span class="badge bg-light-success text-success">Available</span>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Afternoon (12:00 PM - 4:00 PM)</span>
                    <span class="badge bg-light-warning text-warning">Limited</span>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>Evening (4:00 PM - 6:00 PM)</span>
                    <span class="badge bg-light-danger text-danger">Booked</span>
                  </div>
                </li>
              </ul>
              <div class="p-3 text-center">
                <a href="/appointments" class="btn btn-outline-primary btn-sm">View Full Schedule</a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Patient Quick Info Card - for quick reference when booking -->
        <div class="col-md-12">
          <div class="card" id="patientInfoCard" style="display: none;">
            <div class="card-header">
              <h5>Patient Information</h5>
            </div>
            <div class="card-body" id="patientInfoContent">
              <div class="row">
                <div class="col-md-6">
                  <table class="table table-borderless mb-0">
                    <tbody>
                      <tr>
                        <th class="ps-0" width="200">Name:</th>
                        <td id="patientName"></td>
                      </tr>
                      <tr>
                        <th class="ps-0">Diagnosis:</th>
                        <td id="patientDiagnosis"></td>
                      </tr>
                      <tr>
                        <th class="ps-0">Phone:</th>
                        <td id="patientPhone"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <div class="col-md-6">
                  <table class="table table-borderless mb-0">
                    <tbody>
                      <tr>
                        <th class="ps-0" width="200">Last Appointment:</th>
                        <td id="lastAppointment">--</td>
                      </tr>
                      <tr>
                        <th class="ps-0">Treatment Plan:</th>
                        <td id="treatmentPlan">--</td>
                      </tr>
                      <tr>
                        <th class="ps-0">Insurance:</th>
                        <td id="patientInsurance">--</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Repeating Appointments Section -->
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <h5>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="enableRepeatingAppointments">
                  <label class="form-check-label" for="enableRepeatingAppointments">
                    Create Repeating Appointments
                  </label>
                </div>
              </h5>
            </div>
            <div class="card-body" id="repeatingAppointmentsSection" style="display: none;">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label" for="repeatFrequency">Frequency</label>
                    <select class="form-select" id="repeatFrequency" name="repeatFrequency">
                      <option value="weekly" selected>Weekly</option>
                      <option value="biweekly">Every 2 Weeks</option>
                      <option value="monthly">Monthly</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label class="form-label" for="repeatCount">Number of Appointments</label>
                    <select class="form-select" id="repeatCount" name="repeatCount">
                      <option value="2">2 appointments</option>
                      <option value="3">3 appointments</option>
                      <option value="4" selected>4 appointments</option>
                      <option value="6">6 appointments</option>
                      <option value="8">8 appointments</option>
                      <option value="12">12 appointments</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-12">
                  <div class="form-group">
                    <label class="form-label">Preview of Scheduled Dates</label>
                    <div class="table-responsive">
                      <table class="table table-sm" id="repeatDatesPreview">
                        <thead>
                          <tr>
                            <th width="40">#</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td colspan="4" class="text-center">Set appointment details to see preview</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Footer -->
  <footer class="pc-footer">
    <div class="footer-wrapper container-fluid">
      <div class="row">
        <div class="col-auto my-1">
          <ul class="list-inline footer-link mb-0"></ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- Conflict Warning Modal -->
  <div class="modal fade" id="conflictModal" tabindex="-1" aria-labelledby="conflictModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="conflictModalLabel">Scheduling Conflict</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-0">
            <h6 class="alert-heading"><i class="ti ti-alert-triangle me-2"></i>Time Slot Conflict Detected</h6>
            <p id="conflictMessage">There is already an appointment scheduled at this time. Would you like to choose a different time or proceed anyway?</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Change Time</button>
          <button type="button" class="btn btn-warning" id="proceedAnyway">Proceed Anyway</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Required Scripts -->
  <script src="../static/assets/js/plugins/popper.min.js"></script>
  <script src="../static/assets/js/plugins/simplebar.min.js"></script>
  <script src="../static/assets/js/plugins/bootstrap.min.js"></script>
  <script src="../static/assets/js/fonts/custom-font.js"></script>
  <script src="../static/assets/js/pcoded.js"></script>
  <script src="../static/assets/js/plugins/feather.min.js"></script>
  
  <!-- Select2 JS -->
  <script src="../static/assets/js/plugins/select2.min.js"></script>
  
  <!-- DateTimePicker JS -->
  <script src="../static/assets/js/plugins/flatpickr.min.js"></script>
  
  <!-- Custom Scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Init layout
      layout_change('light');
      change_box_container('false');
      layout_rtl_change('false');
      preset_change("preset-1");
      font_change("Public-Sans");
      
      // Initialize Select2
      $('.select2').select2({
        width: '100%',
        placeholder: 'Select Patient'
      });
      
      // Set default time values
      const currentHour = new Date().getHours();
      let defaultTime;
      
      // Default to next available hour during business hours (8am-5pm)
      if (currentHour < 8) {
        defaultTime = '08:00'; // Start of day
      } else if (currentHour >= 17) {
        defaultTime = '08:00'; // Next day beginning
      } else {
        // Next full hour
        defaultTime = `${currentHour + 1}:00`;
      }
      
      document.getElementById('appointment_time').value = defaultTime;
      
      // Form validation
      document.getElementById('appointmentForm').addEventListener('submit', function(event) {
        const patientId = document.getElementById('patient_id').value;
        const appointmentDate = document.getElementById('appointment_date').value;
        const appointmentTime = document.getElementById('appointment_time').value;
        
        if (!patientId || !appointmentDate || !appointmentTime) {
          event.preventDefault();
          alert('Please fill in all required fields');
        }
      });
      
      // Show patient info when a patient is selected
      document.getElementById('patient_id').addEventListener('change', function() {
        const patientId = this.value;
        if (patientId) {
          fetchPatientInfo(patientId);
        } else {
          document.getElementById('patientInfoCard').style.display = 'none';
        }
      });
      
      // Function to fetch patient info via API
      function fetchPatientInfo(patientId) {
        // This is where you would make an AJAX call to your API to get patient details
        // For demonstration, we'll use dummy data
        const patientInfo = patientsData.find(patient => patient.id == patientId);
        
        if (patientInfo) {
          document.getElementById('patientName').textContent = patientInfo.name;
          document.getElementById('patientDiagnosis').textContent = patientInfo.diagnosis || 'Not specified';
          document.getElementById('patientPhone').textContent = patientInfo.phone || 'Not available';
          document.getElementById('lastAppointment').textContent = patientInfo.lastAppointment || 'No previous appointments';
          document.getElementById('treatmentPlan').textContent = patientInfo.treatmentPlan || 'Not assigned';
          document.getElementById('patientInsurance').textContent = patientInfo.insurance || 'Not provided';
          
          document.getElementById('patientInfoCard').style.display = 'block';
        }
      }
      
      // Toggle repeating appointments section
      document.getElementById('enableRepeatingAppointments').addEventListener('change', function() {
        document.getElementById('repeatingAppointmentsSection').style.display = this.checked ? 'block' : 'none';
        if (this.checked) {
          updateRepeatingDatesPreview();
        }
      });
      
      // Update repeating dates preview when changes are made
      document.getElementById('appointment_date').addEventListener('change', updateRepeatingDatesPreview);
      document.getElementById('appointment_time').addEventListener('change', updateRepeatingDatesPreview);
      document.getElementById('repeatFrequency').addEventListener('change', updateRepeatingDatesPreview);
      document.getElementById('repeatCount').addEventListener('change', updateRepeatingDatesPreview);
      
      // Function to update repeating dates preview
      function updateRepeatingDatesPreview() {
        if (!document.getElementById('enableRepeatingAppointments').checked) return;
        
        const startDate = document.getElementById('appointment_date').value;
        if (!startDate) return;
        
        const time = document.getElementById('appointment_time').value;
        const frequency = document.getElementById('repeatFrequency').value;
        const count = parseInt(document.getElementById('repeatCount').value);
        
        const tableBody = document.getElementById('repeatDatesPreview').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        
        let currentDate = new Date(startDate);
        
        for (let i = 0; i < count; i++) {
          const row = document.createElement('tr');
          
          const numberCell = document.createElement('td');
          numberCell.textContent = i + 1;
          
          const dateCell = document.createElement('td');
          dateCell.textContent = formatDate(currentDate);
          
          const timeCell = document.createElement('td');
          timeCell.textContent = formatTime(time);
          
          const statusCell = document.createElement('td');
          if (i === 0) {
            statusCell.innerHTML = '<span class="badge bg-light-primary text-primary">Initial</span>';
          } else {
            statusCell.innerHTML = '<span class="badge bg-light-success text-success">Available</span>';
          }
          
          row.appendChild(numberCell);
          row.appendChild(dateCell);
          row.appendChild(timeCell);
          row.appendChild(statusCell);
          
          tableBody.appendChild(row);
          
          // Calculate next date based on frequency
          if (frequency === 'weekly') {
            currentDate.setDate(currentDate.getDate() + 7);
          } else if (frequency === 'biweekly') {
            currentDate.setDate(currentDate.getDate() + 14);
          } else if (frequency === 'monthly') {
            currentDate.setMonth(currentDate.getMonth() + 1);
          }
        }
      }
      
      // Format date as "Mon, Jan 1, 2023"
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { 
          weekday: 'short',
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
      }
      
      // Format time from 24h to 12h
      function formatTime(timeStr) {
        const [hours, minutes] = timeStr.split(':');
        let period = 'AM';
        let hour = parseInt(hours);
        
        if (hour >= 12) {
          period = 'PM';
          if (hour > 12) hour -= 12;
        }
        if (hour === 0) hour = 12;
        
        return `${hour}:${minutes} ${period}`;
      }
      
      // Dummy data for patient info display
      // In a real application, this would come from your API
      const patientsData = [
        {% for patient in patients %}
        {
          id: {{ patient.patient_id }},
          name: "{{ patient.first_name }} {{ patient.last_name }}",
          diagnosis: "{{ patient.diagnosis|default('Not specified') }}",
          phone: "{{ patient.phone|default('Not available') }}",
          lastAppointment: "{% if patient.last_appointment %}{{ patient.last_appointment }}{% else %}No previous appointments{% endif %}",
          treatmentPlan: "{% if patient.treatment_plan %}{{ patient.treatment_plan }}{% else %}Not assigned{% endif %}",
          insurance: "{% if patient.insurance %}{{ patient.insurance }}{% else %}Not provided{% endif %}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];
      
      // Check for scheduling conflicts
      document.getElementById('appointmentForm').addEventListener('submit', function(event) {
        const selectedDate = document.getElementById('appointment_date').value;
        const selectedTime = document.getElementById('appointment_time').value;
        
        // Demo conflict detection - in a real app, you would check against your database
        const hasConflict = Math.random() > 0.7; // 30% chance of conflict for demo
        
        if (hasConflict) {
          event.preventDefault();
          const conflictModal = new bootstrap.Modal(document.getElementById('conflictModal'));
          conflictModal.show();
        }
      });
      
      // Handle "Proceed Anyway" button in conflict modal
      document.getElementById('proceedAnyway').addEventListener('click', function() {
        document.getElementById('appointmentForm').submit();
      });
    });
  </script>
</body>
</html>